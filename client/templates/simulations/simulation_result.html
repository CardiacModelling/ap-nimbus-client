{% extends "base.html" %}
{% load static %}
{% load simulations %}


{% block title %}Edit simulations info - {% endblock title %}

{% block content %}
{% endblock content %}

{% block data %}
<section id="simulationresults">
<h1 id="entityname">{% include "./simulation_header.html" %}Simulation: {{ object.title }}.</h1>
<small>Created <time>{{object.created_at}}</time> by <em>{{object.author.full_name}}</em>.</small>
<style>

/* Create two equal columns that sits next to each other */
.column, .graph-column, .control-column {
  border: 1px solid red;
}

.legend {
		display: block;
		-webkit-padding-start: 2px;
		-webkit-padding-end: 2px;
		border-width: initial;
		border-style: none;
		border-color: initial;
		border-image: initial;
		padding-left: 10px;
        padding-right: 10px;
        padding-top: 10px;
        padding-bottom: 10px;
}

.legendLayer .background {
    fill: rgba(255, 255, 255, 0.85);
    stroke: rgba(0, 0, 0, 0.85);
    stroke-width: 1;
}

.control-items{
    padding: 100px 0;
}

#legendContainerQnet{
    width:9em;
    height:8em;
    border-style:solid;
    border-color:threedface;
}

#tooltip{
    position: absolute;
    display: none;
    border: 1px solid #fdd;
    padding: 2px;
    background-color: #fee;
    opacity: 0.80;
}

</style>


<div class="row">
  <div class="column">
  <fieldset>
    <legend>Info</legend>{{object.title}}
    <fieldset>
      <legend>Title</legend>{{object.title}}
    </fieldset>
    <fieldset>
    <legend>Notes</legend>
       <div class="markdowrenderview">
         <textarea class="markdownsource">{{object.notes | safe}}</textarea>
       </div>
    </fieldset>
  </fieldset>
  <fieldset>
    <legend>Simulation parameters</legend>
      <fieldset><legend>Model</legend>{{ object.model }}</fieldset>
      <fieldset><legend>Pacing</legend>
        <div><label>Frequency: </label> {{ object.pacing_frequency }} (Hz)</div>
        <div><label>Max time: </label> {{ object.maximum_pacing_time }} (mins)</div>
      </fieldset>
      <fieldset>
        <legend>Ion Channel Current Inhibitory Concentrations</legend>
        <table class="ioncurrent-formset" id="ioncurrent-formset">
          <thead><tr><th colspan="2">Ion Current {{object.ion_current_type}}</th>
                     <th>Hill <br/>Coefficient</th>
                     <th>Saturation <br/>Level (%)</th>
                     <th>Spread of <br/>Uncertainty</th>
                     <th>Channel <br/>protein</th><th>Gene</th>
                     <th>Description</th>
                 </tr>
          </thead>
          <tbody>
            {% ion_currents as all_currents %}
            {% for current in all_currents %}
            {% simulation_ion_current object current as currentparam %}
            <tr><td>{{ current }}</td>
                <td>{{ currentparam.current }}{% if currentparam.current%} ({{object.ion_units}}){% endif %}</td>
                <td>{{ currentparam.hill_coefficient}}</td>
                <td>{{ currentparam.saturation_level }}</td>
                <td>{{ currentparam.spread_of_uncertainty }}</td>
                <td>{{ current.channel_protein|safe }}</td>
                <td>{{ current.gene }}</td>
                <td>{{ current.description }}</td></tr>
            {% endfor %}
          </tbody>
        </table>
    </fieldset>
    <fieldset>
      <legend>{% print_field_name object.pk_or_concs %}</legend>
      {% print_compound_concentrations object as inhconc %}
      {{ inhconc.0 }}
    </fieldset>
    <fieldset>
      <legend>Status</legend>
      <div id="progressbar-{{object.pk}}" class="progressbar progressbar-wide"><div class="progress-label"></div></div>
      {% if object.api_errors %}<div><label>API errors: </label> {{ object.api_errors }} (mins)</div>{% endif %}
      {% if object.messages %}<div><label>AP Predict messages: </label> {{ object.messages }} (mins)</div>{% endif %}
    </fieldset>
    <fieldset>
      <legend>Actions</legend>
        <ul>
          <li><a title="Edit this simulation info" href="{% url 'simulations:simulation_edit' object.id %}" title="Edit the information"><img src="{% static 'images/edit.png' %}" alt="Edit"/> Edit info.</a></li>
          <li><a title="Use simulation as template for a new simulation" href="{% url 'simulations:simulation_template' object.id %}" title="Use as a template to create a new simulation"><img src="{% static 'images/template.png' %}" alt="Use as template"/> Use as template.</a></li>
          <li><a title="Export as spreadsheet (.xlsx)" href="{% url 'simulations:simulation_spreadsheet' object.id %}" title="Export as spreadsheet (.xlsx)"><img src="{% static 'images/spreadsheet.png' %}" alt="Export as spreadsheet (.xlsx)"/> Export as spreadsheet.</a></li>
          <li><a title="Restart the simulation" href="{% url 'simulations:simulation_restart' object.id %}" title="Restart the simulation"><img src="{% static 'images/restart.png' %}" alt="Restart the simulation"/> Restart.</a></li>
          <li><a title="Delete this simulation and all results" href="{% url 'simulations:simulation_delete' object.id %}" title="Delete"><img src="{% static 'images/delete.png' %}" alt="Delete"/> Delete.</a></li>
      </ul>
    </fieldset>
  </fieldset>

  </div>
  <div class="column">
    <div class="row">
        <div class="graph-column">
            <fieldset><legend><button type="button" class="graph-button" id="adp90">Δ APD90 vs. Conc</button><button type="button" class="graph-button" id="qnet">qNet vs. Conc</button></legend>
              <div class="zoom-msg">Zoom in by selecting a region or using your mouse scroll wheel.</div>
              <div id="adp90-graph" style="width:550px;height:300px">
              </div>
              <div id="qnet-graph" style="width:550px;height:300px;">
                  <div><label>qnet: </label> {{ object.maximum_pacing_time }} (mins)</div>
              </div>
            </fieldset>
        </div>
        <div class="control-column">
            <div class="control-items">
                <div id="qnetSource"><label>Source</label></div>
                <div id="legendContaineradp90" class="legend"></div>
                <button type="button" id="resetqnet">Reset graph</button>
                <div id="hoverdata"><p><label>Conc.:</label>  µM</p><p><label>Δ APD90: </label> %</p></div>
            </div>
        </div>
    </div>
    <div class="row">
        <div class="graph-column">
            <h2>Results 1</h2>
            <p>Some text..</p>
        </div>
        <div class="control-column">
            <h2>Download</h2>
            <p>Some text..</p>
        </div>
    </div>
  </div>
</div>
<div id='tooltip'></div>
</section>

        <script language="javascript" type="text/javascript" src="https://www.flotcharts.org/flot/source/jquery.canvaswrapper.js"></script>
        <script language="javascript" type="text/javascript" src="https://www.flotcharts.org/flot/source/jquery.colorhelpers.js"></script>
        <script language="javascript" type="text/javascript" src="https://www.flotcharts.org/flot/source/jquery.flot.js"></script>
        <script language="javascript" type="text/javascript" src="https://www.flotcharts.org/flot/source/jquery.flot.saturated.js"></script>
        <script language="javascript" type="text/javascript" src="https://www.flotcharts.org/flot/source/jquery.flot.browser.js"></script>
        <script language="javascript" type="text/javascript" src="https://www.flotcharts.org/flot/source/jquery.flot.drawSeries.js"></script>
        <script language="javascript" type="text/javascript" src="https://www.flotcharts.org/flot/source/jquery.flot.uiConstants.js"></script>
        <script language="javascript" type="text/javascript" src="https://www.flotcharts.org/flot/source/jquery.flot.selection.js"></script>
        <script language="javascript" type="text/javascript" src="https://www.flotcharts.org/flot/source/jquery.flot.axislabels.js"></script>


        <script language="javascript" type="text/javascript" src="https://www.flotcharts.org/flot/lib/jquery.event.drag.js"></script>
        <script language="javascript" type="text/javascript" src="https://www.flotcharts.org/flot/lib/jquery.mousewheel.js"></script>
        <script language="javascript" type="text/javascript" src="https://www.flotcharts.org/flot/source/jquery.flot.navigate.js"></script>
        <script language="javascript" type="text/javascript" src="https://www.flotcharts.org/flot/source/jquery.flot.touchNavigate.js"></script>
        <script language="javascript" type="text/javascript" src="https://www.flotcharts.org/flot/source/jquery.flot.hover.js"></script>
        <script language="javascript" type="text/javascript" src="https://www.flotcharts.org/flot/source/jquery.flot.touch.js"></script>

        <script language="javascript" type="text/javascript" src="https://www.flotcharts.org/flot/source/jquery.flot.symbol.js"></script>
        <script language="javascript" type="text/javascript" src="https://www.flotcharts.org/flot/source/jquery.flot.legend.js"></script>
        <script language="javascript" type="text/javascript" src="https://www.flotcharts.org/flot/source/jquery.flot.logaxis.js"></script>

	<script type="text/javascript">
$(function() {
    data = {adp90: [{label: "Simulation @ 0.5 Hz", data:[[0, 0],
                                                        [0.001, 0.0172213],
                                                        [0.00329677, 0.056906],
                                                        [0.0108687, 0.187568],
                                                        [0.0358315, 0.616387],
                                                        [0.118128, 2.0087],
                                                        [0.38944, 6.3821],
                                                        [1.28389, 18.8775],
                                                        [4.2327, 47.835],
                                                        [13.9542, 98.9162],
                                                        [46.0038, 173.981],
                                                        [151.664, 258.132],
                                                        [500, 476.319]]
                  }],
            qnet: [{label: "Simulation @ 0.5 Hz", data:[[0, 0.0690176],
                                                        [0.001, 0.069005],
                                                        [0.00329677, 0.0689783],
                                                        [0.0108687, 0.0688906],
                                                        [0.0358315, 0.0686047],
                                                        [0.118128, 0.0676783],
                                                        [0.38944, 0.0648382],
                                                        [1.28389, 0.0573016],
                                                        [4.2327, 0.0433198],
                                                        [13.9542, 0.0302223],
                                                        [46.0038, 0.0293574],
                                                        [151.664, 0.0396153],
                                                        [500, 0.0449682]]
                  }]
           }
                             
    function zoom(ranges, graphId, options, data){
        zoomOptions = $.extend({}, options, {xaxis: { min: ranges.xaxis.from, max: ranges.xaxis.to, autoScale: 'none' },
                                             yaxis: { min: ranges.yaxis.from, max: ranges.yaxis.to, autoScale: 'none' }})
        plot = $.plot(graphId, data, zoomOptions);

    }

    function hover(event, pos, item, x_label, x_units, y_label, y_units){
        if (pos.x && pos.y) {
            x = pos.x.toFixed(3);
            y = pos.y.toFixed(3);
            var hoverData = '<p><label>' + x_label +'</label>' + x + x_units + '</p><p>' + '<label>' + y_label +'</label>' + y + y_units + '</p>';
            $("#hoverdata").html(hoverData);
            if (item) {
                x = item.datapoint[0].toFixed(3);
                y = item.datapoint[1].toFixed(3);
                content = '[' + item.series.label + '] : ' + x_label + x + x_units + ' - ' + y_label + y + y_units;
                $("#tooltip").html(content)
                             .css({top: item.pageY+5, left: item.pageX+5})
                             .fadeIn(200);
            }else{
                $("#tooltip").fadeOut(200);
                
            }
        }
    }

    function hoverOut (x_label, x_units, y_label, y_units) {
        $("#tooltip").hide();
        var hoverData = '<p><label>' + x_label +'</label>' + x_units + '</p><p>' + '<label>' + y_label +'</label>' + y_units + '</p>';
        $("#hoverdata").html(hoverData);
    }

    // setup adp90
    var adp90Options = {legend: {show: true, container: $('#legendContaineradp90').get(0)},
                       series: {lines: {show: true}, points: {show: true}},
                       grid: {hoverable: true, clickable: true},
                       zoom: {interactive: true},
                       xaxis: {axisLabelUseCanvas: true, axisLabelPadding: 10, position: 'bottom', axisLabel: 'Concentration (μM)', mode: "log", showTicks: false, showTickLabels: "all", autoscaleMargin: 0.05, },
                       yaxis: {axisLabelUseCanvas: true, axisLabelPadding: 10, position: 'left', axisLabel: 'Δ APD90 (%)', showTicks: false, showTickLabels: "all", autoscaleMargin: 0.05},
                       selection: {mode: "xy"}
    };

    $.plot("#adp90-graph", data['adp90'], adp90Options);
    $("#adp90-graph").bind("plotselected", (event, ranges) => zoom(ranges, '#adp90-graph', adp90Options, data['adp90']));
    $("#adp90-graph").bind("plothover", (event, pos, item) => hover(event, pos, item, 'Conc.: ', ' µM', 'Δ APD90: ', ' %'));
    $("#adp90-graph").mouseout((event)=>hoverOut('Conc.: ', ' µM', 'Δ APD90: ', ' %'));

    qnetOptions=adp90Options;
    qnetOptions['legend']={'show': false};
    qnetOptions['yaxis']['axisLabel'] = 'qNet (C/F)';
    $.plot("#qnet-graph", data['qnet'], qnetOptions);
    $("#qnet-graph").bind("plotselected", (event, ranges) => zoom(ranges, '#qnet-graph', qnetOptions, data['qnet']));
    $("#qnet-graph").bind("plothover", (event, pos, item) => hover(event, pos, item, 'Conc.: ', ' µM', 'qNet: ', ' C/F'));
    $("#qnet-graph").mouseout((event)=>hoverOut('Conc.: ', ' µM', 'qNet: ', ' C/F'));
    $('#adp90').click(); // now select adp90 graph

    $('#resetqnet').click(function(){
        if($("#adp90-graph").hasClass("show-graph")){
            $.plot("#adp90-graph", data['adp90'], adp90Options);
        }else if($("#qnet-graph").hasClass("show-graph")){
            $.plot("#qnet-graph", data['qnet'], qnetOptions);
        }
    });
});
</script>

{% endblock data %}
